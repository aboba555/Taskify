name: Deploy to Raspberry Pi

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Restore dependencies
        run: ~/.dotnet/dotnet restore
        
      - name: Run tests
        run: ~/.dotnet/dotnet test --no-restore
      
      - name: Publish
        run: ~/.dotnet/dotnet publish Taskify/Taskify.csproj -c Release -o ./publish
      
      - name: Stop service
        run: sudo systemctl stop taskify
      
      - name: Deploy files
        run: |
          rm -rf ~/backend/*
          cp -r ./publish/* ~/backend/
          cp ~/config/appsettings.Production.json ~/backend/appsettings.json
      
      - name: Start service
        run: sudo systemctl start taskify
      
      - name: Verify deployment
        run: |
          sleep 3
          systemctl is-active taskify && echo "âœ… Deployed successfully!"
